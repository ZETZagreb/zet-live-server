<!DOCTYPE html>
<html>
<head>
    <title>ZET Live - Javna Karta</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        #map { height: 100vh; width: 100%; background-color: #a3ccff; }
        body { margin: 0; padding: 0; font-family: sans-serif; }
        .vozilo-ikona {
            font-size: 24px;
            background: white;
            border: 2px solid blue;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            width: 30px !important;
            height: 30px !important;
        }
        .ikona-bus { border-color: orange; }
        #status {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div id="status">Povezivanje...</div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        window.onload = function() {
            var map = L.map('map').setView([45.815, 15.981], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            var markers = {};
            var povijestBrzina = {};
            var zadnjeVrijeme = Date.now();
            var statusDiv = document.getElementById('status');

            function getDistance(lat1, lon1, lat2, lon2) {
                var R = 6371e3;
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLon = (lon2 - lon1) * Math.PI / 180;
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            async function osvjezi() {
                try {
                    statusDiv.innerText = "DohvaÄ‡am podatke...";
                    const sad = Date.now();
                    const dt = (sad - zadnjeVrijeme) / 1000;
                    zadnjeVrijeme = sad;

                    // Koristimo tvoj toÄan Render link
                    const res = await fetch('https://zet-live-server-1.onrender.com/podaci?t=' + sad);
                    const vozila = await res.json();

                    statusDiv.innerText = "UÅ¾ivo: " + vozila.length + " vozila";
                    statusDiv.style.color = "green";

                    vozila.forEach(v => {
                        let emoji = v.tip === 'tram' ? 'ðŸšƒ' : 'ðŸšŒ';
                        let klasa = v.tip === 'tram' ? 'vozilo-ikona' : 'vozilo-ikona ikona-bus';
                        
                        if (markers[v.id]) {
                            let staraPos = markers[v.id].getLatLng();
                            let dist = getDistance(staraPos.lat, staraPos.lng, v.lat, v.lon);
                            let trenutnaBrzina = (dist / dt) * 3.6;
                            if (trenutnaBrzina > 100) trenutnaBrzina = 0;

                            if (!povijestBrzina[v.id]) povijestBrzina[v.id] = [];
                            povijestBrzina
